## 指标异动根因定位系统 - 详细设计

本设计为“指标异动根因定位”系统的工程化落地文档，面向数据工程、算法、前端/后端研发与运维。内容包含需求与约束、整体架构、元数据与配置、计算口径与算法、StarRocks 实现模板、结果模型与 API、调度与治理、安全合规、监控告警、测试验收以及前端交互规范等。

### 1. 背景与目标
- 背景：业务关注核心指标在不同周期的波动，希望快速定位造成波动的关键因素（维度值/子指标），并能在“指标树”视角衡量各环节的贡献与影响。
- 目标：
  - 对比本周期与对比周期，计算指标树各节点的数值变化、波动幅度、本层与整体贡献。
  - 对基础指标在维度层面进行单维归因（EP/Surprise），输出可排序的候选根因。
  - 对乘法/除法节点采用 LMDI 分解，给出各因子对父节点波动的贡献。
  - 提供统一的结果模型和 API，支撑可视化展示与回放。
  - 支持按日/周预计算与在线快速查询。

### 2. 术语与定义
- 本期（current）：分析的目标周期。
- 对比期（baseline）：与本期对比的历史周期（上一日/上一周/去年同期/自定义等）。
- 指标树：根节点到叶子节点的指标组成与运算关系，有加/减/乘/除四类。
- 基础指标（basic）：直接由事实数据聚合得到（和/计数等）。
- 比率指标（ratio）：分子/分母之比（如平均值、比率、率类）。
- 单维归因：对某个基础指标在单个维度（如借据状态）上进行 EP/Surprise 计算，定位候选根因。
- EP：期望贡献比例。EP(v) = (a_v - f_v) / Σ(a_v - f_v)
- Surprise：信息量衡量，使用对数底 10（LOG10），衡量“出乎预期”的程度。
- LMDI：Log Mean Divisia Index，对乘法/除法关系做可加分解。

### 3. 需求
#### 3.1 功能性
- 支持按 `tree_id/version` 解析指标树并执行本期/对比期对比。
- 支持节点间波动计算（数值、幅度）、本层贡献与整体贡献计算。
- 支持乘/除法节点的 LMDI 分解。
- 支持基础指标的维度单维归因（EP/Surprise，StarRocks SQL 实现）。
- 支持配置化 TopN 与阈值（EP 门限、累计门限）。
- 支持统一结果表写入、查询 API、回放与导出。

#### 3.2 非功能性
- 时延：单树在线分析 P95 < 3s（有缓存/预计算前提）；复杂树线下预计算。
- 准确性：与 Python 校验脚本在给定样例上数值一致。
- 可扩展性：可新增新指标树、节点与维度，无需改代码。
- 稳定性：异常数据（零、负、缺失）有清晰处理策略。

### 4. 总体架构
```mermaid
flowchart TD
  A[请求/任务] --> B[读取指标树 YAML/元数据]
  B --> C{自底向上计算节点值}
  C -->|加/减| D[代数求和计算 Δ 与贡献]
  C -->|乘/除| E[LMDI 分解 Δ]
  D --> F[节点指标汇总]
  E --> F
  F --> G{是否需要维度归因?}
  G -->|basic/声明可拆解| H[StarRocks SQL 计算 EP/Surprise(LOG10)]
  G -->|ratio| I[回落到分子/分母进行维度归因]
  H --> J[写入 t_dim_result]
  F --> K[写入 t_node_result]
  B --> L[写入 t_analysis_run]
  K --> M[API/前端树展示]
  J --> N[节点弹窗-单维归因表]
```

### 5. 元数据与配置
#### 5.1 指标树 YAML 结构（规范化）
- 放置位置：`config/metric_trees/{tree_id}.yml`
- 关键字段：
  - `tree_id/tree_name/version`
  - `root`：根节点定义
  - `nodes`：非根节点定义列表
  - `time`：对比方式与周期
  - 节点字段：`node_id`、`metric_id`、`metric_type`（basic/ratio/derived/composite）、`op`（add/sub/mul/div）、`children`、`decomposable_dimensions`、`datasource.*`、`params`

示例（节选，完整 YAML 参考简要设计文档）：
```yaml
tree_id: loan_balance_increment
version: 1
root:
  node_id: loan_inc
  metric_id: finance.loan_increase_amount
  metric_type: derived
  op: sub
  children: [disbursement, repayment]
nodes:
  - node_id: disbursement
    metric_id: finance.disbursement_amount
    metric_type: composite
    op: mul
    children: [drawdown_cust_cnt, avg_drawdown_amt]
    decomposable_dimensions: [ent_credit_period, usage_status, package_type]
    datasource:
      model_id: loan_txn_model
      fact_table: dws_custom_kj_serial_guarantee_txn_da
      time_col: put_out_date
      measure_field: business_sum
    params:
      ep_threshold: 0.1
      ep_total_threshold: 0.67
```

#### 5.2 与现有元数据表的映射
- `metric_id` → `t_metric_metadata.metric_id`：获取技术口径、聚合表达式、单位、所属模型。
- 维度定义 → `t_data_model_field`（field_type=dimension）、`t_dimension`、`t_dimension_field`。
- 模型与事实表 → `t_data_model.fact_table`，分区列 `partition_column`。
- 如 YAML `datasource.*` 为空，则优先用 `t_metric_metadata.expression/field/agg_func`。

#### 5.3 配置校验与发布
- 语法校验：YAML 结构、必填字段、节点引用闭包校验、无环性校验。
- 口径校验：`metric_id` 在元数据存在、字段/模型可解析、节点运算与类型匹配。
- 发布：写入 `t_metric_tree`、`t_metric_tree_node` 并冻结版本；配置快照随运行写入 `t_analysis_run.config_snapshot`。

### 6. 计算口径与算法
#### 6.1 基础定义
- 节点 \(X\)：\(X^{cur}, X^{base}\)；\(\Delta X = X^{cur}-X^{base}\)；\(\delta X = \frac{\Delta X}{\max(\varepsilon, |X^{base}|)}\)。
- 本层贡献：\(C^{local}_i = \frac{\Delta X_i}{\max(\varepsilon, |\Delta X_p|)}\)
- 整体贡献：\(C^{global}_i = \frac{\Delta X_i}{\max(\varepsilon, |\Delta X_{root}|)}\)

#### 6.2 加/减法节点
- 父节点：\(\Delta X_p = \sum_i s_i \cdot \Delta X_i\)，其中 \(s_i \in \{+1,-1\}\) 表示加/减。
- 贡献按子项 \(\Delta\) 在父/根 \(\Delta\) 的占比计算。

#### 6.3 乘/除法节点（LMDI）
多因子 \(Y=\prod_{k=1}^n F_k\)，定义对数均值权重：
\[
\Delta Y_k = L(Y^{cur}, Y^{base}) \cdot \ln\!\left(\frac{F_k^{cur}}{F_k^{base}}\right), \quad
L(x,y)=\frac{x-y}{\ln x - \ln y}
\]
- 当 \(x=y\) 取极限 \(L=x\)；如 \(x\le0\) 或 \(y\le0\)，采用小正数回退与屏蔽策略（记录在 `extra`）。
- 除法 \(Y=A/B\) 视为 \(A \times B^{-1}\)。

#### 6.4 单维归因（基础指标）
- EP：\(\mathrm{EP}(v) = \frac{a_v - f_v}{\sum_v (a_v - f_v)}\)
- Surprise（必须 LOG10）：
\[
\mathrm{Surprise}(v)=\frac{1}{2}\left[p\log_{10}\!\frac{2p}{p+q}+q\log_{10}\!\frac{2q}{p+q}\right],\ 
p=\frac{a_v}{\sum a},\ q=\frac{f_v}{\sum f}
\]
- 阈值：`ep_threshold`，累计阈值 `ep_total_threshold`（类似 0.67）。
- 排序：优先按 `surprise` 或综合打分（可选：`surprise * |EP|`）。

#### 6.5 比率型指标
- 树层：对比率 \(R=N/D\) 的波动采用 LMDI（以 \(N\) 与 \(D^{-1}\) 为因子）。
- 维度层：落至分子/分母对应的基础/复合指标做单维归因，避免直接对比率求 EP/Surprise 带来的噪声与不稳定。
- 若必须对比率做维度归因，可输出“间接贡献”近似项：\(\Delta R \approx w_N \cdot \frac{\Delta N}{N} - w_D \cdot \frac{\Delta D}{D}\)，权重 \(w\) 采用对数均值或对比期权重。

### 7. StarRocks 实现模板
#### 7.1 通用单维归因模板
```sql
WITH cur AS (
  SELECT ${dim} AS dimv, ${agg_expr} AS real
  FROM ${fact_table}
  WHERE ${time_col} = '${current_date}' ${where_ex}
  GROUP BY ${dim}
),
base AS (
  SELECT ${dim} AS dimv, ${agg_expr} AS predict
  FROM ${fact_table}
  WHERE ${time_col} = '${baseline_date}' ${where_ex}
  GROUP BY ${dim}
),
joined AS (
  SELECT COALESCE(c.dimv, b.dimv) AS dimv,
         COALESCE(c.real, 0) AS real,
         COALESCE(b.predict, 0) AS predict
  FROM cur c FULL OUTER JOIN base b ON c.dimv = b.dimv
),
tot AS (
  SELECT SUM(real) AS a_all, SUM(predict) AS f_all, SUM(real - predict) AS delta_all
  FROM joined
)
SELECT j.dimv,
       j.real, j.predict,
       (j.real - j.predict) AS delta_value,
       CASE WHEN t.delta_all = 0 THEN 0 ELSE (j.real - j.predict)/t.delta_all END AS ep,
       CASE
         WHEN t.a_all = 0 OR t.f_all = 0 THEN 0
         ELSE 0.5 * (
           (j.real / t.a_all) * LOG10(2 * (j.real / t.a_all) / NULLIF(((j.real / t.a_all) + (j.predict / t.f_all)), 0))
           + (j.predict / t.f_all) * LOG10(2 * (j.predict / t.f_all) / NULLIF(((j.real / t.a_all) + (j.predict / t.f_all)), 0))
         )
       END AS surprise
FROM joined j CROSS JOIN tot t
ORDER BY surprise DESC
LIMIT ${topn};
```
注意：必须使用 `LOG10`。

#### 7.2 乘法节点 LMDI 的实现思路
- 对每个因子分别计算 \(F_k^{cur}, F_k^{base}\) 与父节点 \(Y^{cur}, Y^{base}\)。
- 在 SQL 中计算 `L = (Y_cur - Y_base) / (LOG(Y_cur) - LOG(Y_base))`（对相等与非正值做好保护）。
- 贡献项 `delta_k = L * (LOG(Fk_cur) - LOG(Fk_base))`。
- 写入 `t_node_result.extra`（JSON）保存各 `delta_k`。

### 8. 结果模型与索引
```sql
CREATE TABLE `t_analysis_run` (
  `run_id` varchar(64) NOT NULL,
  `tree_id` varchar(128) NOT NULL,
  `version` int NOT NULL,
  `current_period` varchar(32) NOT NULL,
  `baseline_period` varchar(32) NOT NULL,
  `status` varchar(16) NOT NULL DEFAULT 'done',
  `config_snapshot` mediumtext,
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`run_id`),
  KEY `idx_tree_ver_time` (`tree_id`,`version`,`current_period`,`baseline_period`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `t_node_result` (
  `run_id` varchar(64) NOT NULL,
  `node_id` varchar(128) NOT NULL,
  `metric_id` varchar(128) NOT NULL,
  `value_cur` decimal(32,6) NOT NULL,
  `value_base` decimal(32,6) NOT NULL,
  `delta_value` decimal(32,6) NOT NULL,
  `delta_rate` decimal(32,6) NOT NULL,
  `contrib_local` decimal(32,6) DEFAULT NULL,
  `contrib_global` decimal(32,6) DEFAULT NULL,
  `extra` text,
  PRIMARY KEY (`run_id`, `node_id`),
  KEY `idx_run_metric` (`run_id`,`metric_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `t_dim_result` (
  `run_id` varchar(64) NOT NULL,
  `node_id` varchar(128) NOT NULL,
  `dim` varchar(128) NOT NULL,
  `dim_value` varchar(256) NOT NULL,
  `real` decimal(32,6) NOT NULL,
  `predict` decimal(32,6) NOT NULL,
  `delta_value` decimal(32,6) NOT NULL,
  `ep` decimal(32,6) NOT NULL,
  `surprise` decimal(32,6) NOT NULL,
  `rank_order` int NOT NULL,
  PRIMARY KEY (`run_id`, `node_id`, `dim`, `dim_value`),
  KEY `idx_run_node_dim` (`run_id`,`node_id`,`dim`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 9. API 设计（最小可用）
```http
POST /api/analysis/run
{ "tree_id": "...", "version": 1, "current_period": "2025-09-12", "baseline_period": "2025-09-05", "topn": 10 }
-> { "run_id": "RID20251111001" }

GET /api/analysis/{run_id}/tree
-> { "root": { "node_id": "...", "value_cur": 0, "value_base": 0, "delta_value": 0, "delta_rate": 0, "contrib_local": 1, "contrib_global": 1, "children": [ ... ] } }

GET /api/analysis/{run_id}/dim?node_id=disbursement&dim=package_type&topn=10
-> [ { "dim_value":"随借随还","real":100,"predict":80,"delta_value":20,"ep":0.2,"surprise":0.03,"rank_order":1 }, ... ]
```

### 10. 运行与调度
- 在线分析：接收请求后实时拉取 StarRocks 计算，适合中小体量与非高并发。
- 预计算：对重点树/节点按日批跑，落结果表，前端直查。
- 缓存：对参数相同的请求做短期缓存；对树结构做长期缓存。
- 幂等：`run_id` 基于参数散列生成；重复请求直接返回已有结果。

### 11. 安全与合规
- 权限：按 `tree_id` 与指标/维度做细粒度鉴权；对敏感字段脱敏。
- 审计：记录调用方/参数/耗时/行数等。
- 数据治理：指标口径由 `t_metric_metadata` 管理；变更需审批与回归测试。

### 12. 监控与告警
- 指标：请求量、成功率、99 线耗时、StarRocks 查询耗时、空结果/异常率。
- 告警：超过阈值触发，落地日志与通知。
- 健康检查：元数据有效性与依赖数据可用性周期巡检。

### 13. 测试与验收
- 单元：口径函数、阈值、容错（零/负/缺失）。
- 集成：与 StarRocks 的 SQL 结果对齐；与 Python 验证脚本一致性。
- 回归：典型树（发放/还款/比率）样例集。
- 灰度：按树维度灰度发布，观察误差与性能。

### 14. 前端交互规范
#### 14.1 树节点 JSON 契约
```json
{
  "node_id": "disbursement",
  "name": "发放金额",
  "value_cur": 3000,
  "value_base": 2000,
  "delta_value": 1000,
  "delta_rate": 0.5,
  "contrib_local": 1.0,
  "contrib_global": 5.0,
  "decomposable_dimensions": ["package_type"],
  "children": [ /* 递归 */ ]
}
```
#### 14.2 交互要点
- 节点卡片展示本期/对比期/波动量/波动幅度/贡献。
- 可展开折叠；点击节点弹出“单维归因”表格（维度值、real、predict、delta、EP、Surprise）。
- 支持切换 TopN、按 Surprise/EP 排序、导出 CSV。

### 15. 边界与异常处理
- 对比期为 0：`delta_rate` 与除法/对数需保护（使用 \(\varepsilon\) 或跳过）。
- 值为负：LMDI 中 log 域外，采用小正数替代并在 `extra` 标注。
- 维度缺失：左/全连接并以 0 填充；对 `EP` 分母为 0 的情况输出 0。
- 数据稀疏：限制 TopN 与最小支持阈值（如 `real+predict` 小于阈值则过滤）。

### 16. 里程碑与落地建议
- M1：完成 YAML -> 运行时 DAG 转换，节点波动与 LMDI 验证，单维归因 SQL 核对。
- M2：结果表与 API，前端树与弹窗 Demo，离线预计算作业。
- M3：治理与监控完善、权限与审计接入、全链路回归。

附：本设计与《指标异动根因定位_简要设计》一致，仅在工程细节、口径说明、异常处理、治理与测试方面做了全面补充。


