# 项目优化说明

## 优化完成日期
2025年11月24日

## 优化内容总结

### 1. 日志优化 ✅

**优化前：**
```java
@Slf4j
public class AttributionController {
    ...
    log.info("查询核心指标列表...");
}
```

**优化后：**
```java
public class AttributionController {
    private static final Logger LOG = LoggerFactory.getLogger(AttributionController.class);
    ...
    LOG.info("查询核心指标列表: metricName={}, limit={}", metricName, limit);
}
```

**变更文件：**
- `src/main/java/com/dosconfig/controller/AttributionController.java`
- `src/main/java/com/dosconfig/exception/GlobalExceptionHandler.java`

### 2. 统一响应结构 ✅

**创建了新的响应类：**
- `BaseResponse<T>` - 统一响应包装类（`cn.webank.dosconfig.entity` 包）
- `ResponseEnum` - 响应码枚举类
- `Constant` - 系统常量类（包含 `SYS_ID`）

**响应结构：**
```java
{
    "respCode": "0",           // 响应码
    "respMsg": "成功",          // 响应消息
    "data": {...},            // 数据载荷
    "bizSeq": "BIZ..."        // 业务流水号（可选）
}
```

**响应码规范：**
- `0` - 成功
- `DOS0001` - 用户鉴权失败
- `DOS0002` - 请求参数错误
- `DOS5000` - 服务异常

**变更文件：**
- `src/main/java/com/dosconfig/common/BaseResponse.java`（新建）
- `src/main/java/com/dosconfig/common/Constant.java`（新建）
- `src/main/java/com/dosconfig/enums/ResponseEnum.java`（新建）

### 3. 异常处理优化 ✅

**创建了新的异常类：**
- `SystemException` - 系统异常类，继承自 `RuntimeException`

**异常类结构：**
```java
public class SystemException extends RuntimeException {
    private String code;
    
    // 支持多种构造方式
    public SystemException()
    public SystemException(ResponseEnum response)
    public SystemException(String message)
    public SystemException(String code, String msg)
}
```

**全局异常处理器更新：**
- 使用 `BaseResponse` 代替 `ApiResponse`
- 添加 `SystemException` 处理器
- 使用 `LOG` 代替 `@Slf4j`
- 直接返回 `BaseResponse`（移除 `ResponseEntity` 包装）

**变更文件：**
- `src/main/java/com/dosconfig/exception/SystemException.java`（新建）
- `src/main/java/com/dosconfig/exception/GlobalExceptionHandler.java`（更新）

### 4. 数据访问层重构（JPA → MyBatis）✅

#### 4.1 Maven 依赖更新

**pom.xml 变更：**
```xml
<!-- 移除 JPA -->
<!-- <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency> -->

<!-- 添加 MyBatis -->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>3.0.3</version>
</dependency>

<!-- 添加 Guava（支持 Preconditions） -->
<dependency>
    <groupId>com.google.guava</groupId>
    <artifactId>guava</artifactId>
    <version>32.1.3-jre</version>
</dependency>
```

#### 4.2 配置文件更新

**application.properties 变更：**
```properties
# 移除 JPA 配置
# spring.jpa.database=mysql
# spring.jpa.show-sql=true
# ...

# 添加 MyBatis 配置
mybatis.mapper-locations=classpath:daoMapper/*.xml
mybatis.type-aliases-package=com.dosconfig.entity
mybatis.configuration.map-underscore-to-camel-case=true
mybatis.configuration.log-impl=org.apache.ibatis.logging.slf4j.Slf4jImpl
```

#### 4.3 DAO 接口层

**创建的 DAO 接口：**
- `MetricDao` - 核心指标 DAO
- `AnalysisTaskDao` - 分析任务 DAO
- `AttributionTreeDao` - 归因树 DAO

**DAO 接口特点：**
- 使用 `@Mapper` 注解
- 使用 `@Param` 注解标识参数
- 包路径：`com.dosconfig.dao`

**示例：**
```java
@Mapper
public interface MetricDao {
    Metric selectByPrimaryKey(@Param("id") Long id);
    Metric selectByMetricId(@Param("metricId") String metricId);
    List<Metric> selectByMetricName(@Param("metricName") String metricName, @Param("limit") Integer limit);
    int insert(Metric metric);
    int updateByPrimaryKey(Metric metric);
    int deleteByPrimaryKey(@Param("id") Long id);
}
```

#### 4.4 Mapper XML 文件

**创建的 Mapper 文件：**
- `MetricDaoMapper.xml` - 核心指标 Mapper
- `AnalysisTaskDaoMapper.xml` - 分析任务 Mapper
- `AttributionTreeDaoMapper.xml` - 归因树 Mapper

**Mapper 文件特点：**
- 位置：`src/main/resources/daoMapper/`
- 使用 `resultMap` 映射结果
- 使用 `<sql>` 定义可重用的 SQL 片段
- 支持动态 SQL（`<if>`, `<where>`）
- 支持分页查询
- BLOB 字段单独定义

**示例结构：**
```xml
<mapper namespace="MetricDao">
    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="Metric">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="metric_id" property="metricId" jdbcType="VARCHAR"/>
        ...
    </resultMap>

    <!-- SQL 片段 -->
    <sql id="Base_Column_List">
        id, metric_id, metric_name, ...
    </sql>

    <!-- 查询方法 -->
    <select id="selectByPrimaryKey" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_metric
        WHERE id = #{id,jdbcType=BIGINT}
    </select>
</mapper>
```

#### 4.5 实体类更新

**Metric 实体类更新：**
- 移除所有 JPA 注解（`@Entity`, `@Table`, `@Column`, `@Id`, `@GeneratedValue`）
- 移除 `@PrePersist`, `@PreUpdate` 回调方法
- 改为纯 POJO，只保留 `@Data` 注解
- 字段名与数据库列名通过驼峰转换自动映射

**变更前：**
```java
@Entity
@Table(name = "t_metric")
@Data
public class Metric {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "metric_id", nullable = false)
    private String metricId;
    ...
}
```

**变更后：**
```java
@Data
public class Metric {
    private Long id;
    private String metricId;
    private String metricName;
    private String metricDesc;
    ...
}
```

### 5. Controller 优化 ✅

**优化内容：**
- 使用 `BaseResponse` 替代 `ApiResponse`
- 移除 `ResponseEntity` 包装，直接返回 `BaseResponse`
- 使用 `LOG` 代替 `@Slf4j`
- 所有方法统一使用 `BaseResponse.ok()` 返回成功结果

**优化前：**
```java
@GetMapping("/metrics")
public ResponseEntity<ApiResponse<List<MetricBriefDTO>>> getMetrics(...) {
    return ResponseEntity.ok(ApiResponse.success(metrics));
}
```

**优化后：**
```java
@GetMapping("/metrics")
public BaseResponse<List<MetricBriefDTO>> getMetrics(...) {
    return BaseResponse.ok(metrics);
}
```

## 文件清单

### 新建文件
```
src/main/java/com/dosconfig/
├── common/
│   ├── BaseResponse.java          ✨ 统一响应包装类
│   └── Constant.java               ✨ 系统常量类
├── dao/                             ✨ DAO 接口层
│   ├── MetricDao.java
│   ├── AnalysisTaskDao.java
│   └── AttributionTreeDao.java
├── enums/
│   └── ResponseEnum.java           ✨ 响应码枚举
└── exception/
    └── SystemException.java        ✨ 系统异常类

src/main/resources/daoMapper/       ✨ MyBatis Mapper XML
├── MetricDaoMapper.xml
├── AnalysisTaskDaoMapper.xml
└── AttributionTreeDaoMapper.xml
```

### 修改文件
```
pom.xml                                              # JPA → MyBatis
src/main/resources/application.properties            # 配置更新
src/main/java/com/dosconfig/
├── controller/
│   └── AttributionController.java                  # 响应结构和日志优化
├── entity/
│   └── Metric.java                                 # 移除 JPA 注解
└── exception/
    └── GlobalExceptionHandler.java                 # 异常处理优化
```

## 后续工作建议

### 1. 数据访问层迁移
现有的 Repository 层需要逐步迁移到 DAO + MyBatis 方式：
- `MetricRepository` → `MetricDao`
- `AnalysisTaskRepository` → `AnalysisTaskDao`
- `AttributionTreeRepository` → `AttributionTreeDao`
- `AttributionResultRepository` → `AttributionResultDao`
- `AiReportRepository` → `AiReportDao`

### 2. 实体类更新
需要更新剩余的实体类，移除 JPA 注解：
- `AnalysisTask.java`
- `AttributionTree.java`
- `AttributionResult.java`
- `AiReport.java`

### 3. Service 层更新
更新 Service 层，使用 DAO 替代 Repository：
```java
// 旧方式
@Autowired
private MetricRepository metricRepository;

// 新方式
@Autowired
private MetricDao metricDao;
```

### 4. 参数校验增强
可以在 Controller 方法中使用 Guava 的 Preconditions：
```java
Preconditions.checkArgument(from >= 1 && limit > 0, "分页参数错误");
Preconditions.checkArgument(
    StringUtils.equalsAny(listType, "user", "enterprise", "", null),
    "名单类型参数错误"
);
```

## 技术栈对比

| 功能 | 优化前 | 优化后 |
|------|--------|--------|
| 日志 | `@Slf4j` + `log` | `Logger` + `LOG` |
| 响应 | `ApiResponse` | `BaseResponse` |
| 异常 | `BusinessException` | `BusinessException` + `SystemException` |
| ORM | Spring Data JPA | MyBatis |
| 实体 | JPA 注解 | 纯 POJO |
| 数据访问 | Repository | DAO + Mapper XML |

## 注意事项

1. **MyBatis 配置**：确保 `mybatis.mapper-locations` 路径正确
2. **包扫描**：确保启动类上有 `@MapperScan("com.dosconfig.dao")` 注解（可选）
3. **事务管理**：MyBatis 仍支持 `@Transactional` 注解
4. **SQL 日志**：通过 `logging.level.com.dosconfig.dao=DEBUG` 查看执行的 SQL
5. **下划线转驼峰**：已启用 `map-underscore-to-camel-case=true`

## 兼容性说明

- 现有的 Repository 层暂时保留，可以逐步迁移
- 新功能建议使用 DAO + MyBatis 方式
- `BaseResponse` 与 `ApiResponse` 可以共存，逐步迁移

