# 接口优化完成说明

## 更新日期
2024年11月24日

---

## 一、优化内容概述

根据需求，本次对指标异动根因定位系统进行了全面的接口优化，主要包括：

1. ✅ 任务状态枚举优化：`DONE` → `SUCCESS`
2. ✅ 核心指标趋势查询接口调整
3. ✅ 发起分析任务接口参数优化
4. ✅ AI归因报告结构简化
5. ✅ 数据库表结构更新
6. ✅ 建表语句更新
7. ✅ 接口文档完善

---

## 二、详细调整内容

### 2.1 时间粒度枚举优化

**变更内容**：
- 新增 `DateGranularity` 枚举类，替代原 `TimeGranularity`
- 实现 `EnumStringParseAble` 接口，支持字符串解析

**新增文件**：
```
src/main/java/cn/webank/dosconfig/enums/
├── EnumStringParseAble.java      # 枚举解析接口
└── DateGranularity.java           # 时间粒度枚举
```

**枚举定义**：
```java
public enum DateGranularity implements EnumStringParseAble<DateGranularity> {
    DAY("day", "yyyy-MM-dd", "%Y-%m-%d"),
    WEEK("week", "yyyy-ww", "%Y-%v"),
    MONTH("month", "yyyy-MM", "%Y-%m"),
    YEAR("year", "yyyy", "%Y");
    
    private final String dateGran;     // 粒度标识
    private final String normalFmt;    // 标准日期格式
    private final String symFmt;       // SQL日期格式
}
```

---

### 2.2 任务状态枚举调整

**变更内容**：
- 修改 `TaskStatus` 枚举：`DONE` → `SUCCESS`

**修改文件**：
```
src/main/java/cn/webank/dosconfig/enums/TaskStatus.java
```

**变更对比**：
```java
// 优化前
DONE,  // 已完成

// 优化后
SUCCESS,  // 已完成（成功）
```

**影响范围**：
- 数据库表 `t_analysis_task` 的 `status` 字段注释更新
- 所有涉及任务状态判断的代码逻辑

---

### 2.3 核心指标趋势查询接口优化

#### 2.3.1 接口调整

**接口地址**：`GET /attribution/metrics/{metricId}/trend`

**入参调整**：

| 调整类型 | 优化前 | 优化后 |
|---------|--------|--------|
| **新增参数** | - | `timeGranularity`（时间粒度） |
| **简化参数** | `baselineStartDate`<br>`baselineEndDate`<br>`compareStartDate`<br>`compareEndDate` | `baselineDate`<br>`compareDate` |

**请求示例对比**：
```http
# 优化前
GET /attribution/metrics/{metricId}/trend
  ?baselineStartDate=2024-01-01
  &baselineEndDate=2024-01-07
  &compareStartDate=2024-01-08
  &compareEndDate=2024-01-14

# 优化后
GET /attribution/metrics/{metricId}/trend
  ?timeGranularity=DAY
  &baselineDate=2024-01-01
  &compareDate=2024-01-08
```

#### 2.3.2 返回结构优化

**新增DTO类**：
```
src/main/java/cn/webank/dosconfig/entity/attribution/dto/response/
├── ChartDataDTO.java    # 图表数据（支持ECharts）
└── MetricItemDTO.java   # 指标项数据
```

**返回结构对比**：

```json
// 优化前
{
  "baselineSeries": [...],
  "compareSeries": [...],
  "baselineAvg": 225.5,
  "compareAvg": 232.1,
  "changeRate": 0.0329
}

// 优化后（通用化设计，支持ECharts）
{
  "chartData": {
    "xAxis": {
      "type": "category",
      "data": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
    },
    "yAxis": {
      "type": "value"
    },
    "series": [
      {
        "name": "基准期",
        "type": "line",
        "data": [150, 230, 224, 218, 135, 147, 260]
      },
      {
        "name": "对比期",
        "type": "line",
        "data": [180, 250, 210, 200, 145, 160, 270]
      }
    ]
  },
  "metricItems": [
    {
      "key": "baselineAvg",
      "value": "195.71",
      "title": "基准期均值",
      "color": "blue",
      "remark": "基准期7天平均值"
    },
    {
      "key": "compareAvg",
      "value": "202.14",
      "title": "对比期均值",
      "color": "green",
      "remark": "对比期7天平均值"
    },
    {
      "key": "changeRate",
      "value": "+3.29%",
      "title": "变化率",
      "color": "red",
      "remark": "对比期相较基准期的变化率"
    }
  ]
}
```

**优化优势**：
1. ✅ 图表数据采用 ECharts 标准格式，前端可直接使用
2. ✅ 关键指标以列表形式返回，支持灵活扩展
3. ✅ 增加颜色和备注字段，提升用户体验

---

### 2.4 发起分析任务接口优化

#### 2.4.1 接口调整

**接口地址**：`POST /attribution/tasks`

**入参调整**：

| 调整类型 | 参数名 | 说明 |
|---------|--------|------|
| **保留** | `treeId` | 归因树ID |
| **保留** | `rosterId` | 名单ID（可选） |
| **保留** | `contributionThreshold` | 贡献度阈值（0.0-1.0） |
| **新增** | `timeGranularity` | 时间粒度（DAY/WEEK/MONTH/YEAR） |
| **简化** | `baselineDate` | 基准日期（替代baselineStartDate/baselineEndDate） |
| **简化** | `compareDate` | 对比日期（替代compareStartDate/compareEndDate） |

**请求示例对比**：
```json
// 优化前
{
  "treeId": "loan_balance_increment",
  "rosterId": null,
  "contributionThreshold": 0.1,
  "baselineStartDate": "2024-01-01",
  "baselineEndDate": "2024-01-07",
  "compareStartDate": "2024-01-08",
  "compareEndDate": "2024-01-14"
}

// 优化后
{
  "treeId": "loan_balance_increment",
  "rosterId": null,
  "contributionThreshold": 0.1,
  "timeGranularity": "DAY",
  "baselineDate": "2024-01-01",
  "compareDate": "2024-01-08"
}
```

#### 2.4.2 返回结构调整

**返回参数新增**：
```json
{
  "taskId": "task_20241124_001",
  "timeGranularity": "DAY",      // 新增
  "baselineDate": "2024-01-01",  // 新增
  "compareDate": "2024-01-08"    // 新增
}
```

**修改文件**：
```
src/main/java/cn/webank/dosconfig/entity/attribution/dto/
├── request/CreateTaskRequest.java   # 请求参数
└── response/TaskCreateDTO.java      # 响应参数
```

---

### 2.5 AI归因报告结构优化

**变更内容**：
- 简化报告结构，从多字段改为单一大TEXT字段
- 完整报告内容统一存储在 `reportContent` 字段

**实体类调整**：
```java
// 优化前
public class AiReport {
    private String summary;      // 摘要
    private String sections;     // 报告章节（JSON格式）
}

// 优化后
public class AiReport {
    private String reportContent;  // 报告内容（完整报告，大TEXT）
}
```

**响应DTO调整**：
```java
// 优化前
public record AiAttributionReportDTO(
    String taskId,
    String reportStatus,
    String summary,
    List<ReportSectionDTO> sections,
    String generateTime
) {}

// 优化后
public record AiAttributionReportDTO(
    String taskId,
    String reportStatus,
    String reportContent,  // 完整报告内容（大TEXT）
    String generateTime
) {}
```

**修改文件**：
```
src/main/java/cn/webank/dosconfig/entity/attribution/
├── AiReport.java                                    # 实体类
└── dto/response/AiAttributionReportDTO.java        # 响应DTO
```

**优化优势**：
1. ✅ 结构更简单，便于维护
2. ✅ 为未来AI生成完整报告预留接口
3. ✅ 减少JSON序列化/反序列化开销

---

### 2.6 数据库表结构调整

#### 2.6.1 t_analysis_task 表调整

**字段变更**：

| 操作 | 字段名（旧） | 字段名（新） | 类型 | 说明 |
|------|------------|------------|------|------|
| 新增 | - | `time_granularity` | VARCHAR(20) | 时间粒度（DAY/WEEK/MONTH/YEAR） |
| 简化 | `baseline_start_date`<br>`baseline_end_date` | `baseline_date` | DATE | 基准日期 |
| 简化 | `compare_start_date`<br>`compare_end_date` | `compare_date` | DATE | 对比日期 |
| 修改 | `status` 注释 | `status` 注释 | VARCHAR(20) | DONE改为SUCCESS |

**建表语句**：
```sql
CREATE TABLE `t_analysis_task` (
  `task_id` VARCHAR(100) NOT NULL COMMENT '任务唯一标识',
  `tree_id` VARCHAR(100) NOT NULL COMMENT '归因树ID',
  `tree_name` VARCHAR(200) DEFAULT NULL COMMENT '归因树名称（冗余字段）',
  `roster_id` VARCHAR(100) DEFAULT NULL COMMENT '名单ID（可选）',
  `contribution_threshold` DECIMAL(24,6) DEFAULT NULL COMMENT '贡献度阈值',
  `time_granularity` VARCHAR(20) NOT NULL COMMENT '时间粒度：DAY-日，WEEK-周，MONTH-月，YEAR-年',
  `baseline_date` DATE NOT NULL COMMENT '基准日期',
  `compare_date` DATE NOT NULL COMMENT '对比日期',
  `status` VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '任务状态：PENDING-待执行，RUNNING-执行中，SUCCESS-已完成，FAILED-失败，CANCELED-已取消',
  `progress` INT DEFAULT 0 COMMENT '执行进度（0-100）',
  `message` VARCHAR(500) DEFAULT NULL COMMENT '状态说明',
  `creator` VARCHAR(100) DEFAULT NULL COMMENT '创建人',
  `create_time` DATETIME NOT NULL COMMENT '创建时间',
  `start_time` DATETIME DEFAULT NULL COMMENT '开始时间',
  `end_time` DATETIME DEFAULT NULL COMMENT '结束时间',
  `update_time` DATETIME NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`task_id`),
  KEY `idx_tree_id` (`tree_id`),
  KEY `idx_tree_name` (`tree_name`),
  KEY `idx_roster_id` (`roster_id`),
  KEY `idx_status` (`status`),
  KEY `idx_creator` (`creator`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_time_granularity` (`time_granularity`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='分析任务表';
```

#### 2.6.2 t_ai_report 表调整

**字段变更**：

| 操作 | 字段名（旧） | 字段名（新） | 类型 | 说明 |
|------|------------|------------|------|------|
| 删除 | `summary` | - | - | 摘要（已移除） |
| 删除 | `sections` | - | - | 报告章节（已移除） |
| 新增 | - | `report_content` | LONGTEXT | 报告内容（完整报告） |

**建表语句**：
```sql
CREATE TABLE `t_ai_report` (
  `task_id` VARCHAR(100) NOT NULL COMMENT '任务ID',
  `report_status` VARCHAR(20) NOT NULL DEFAULT 'GENERATING' COMMENT '报告生成状态：GENERATING-生成中，COMPLETED-已完成，FAILED-生成失败',
  `report_content` LONGTEXT DEFAULT NULL COMMENT '报告内容（完整报告内容，大TEXT）',
  `generate_time` DATETIME DEFAULT NULL COMMENT '生成时间',
  `create_time` DATETIME NOT NULL COMMENT '创建时间',
  PRIMARY KEY (`task_id`),
  KEY `idx_report_status` (`report_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='AI归因报告表';
```

---

### 2.7 MyBatis Mapper XML 更新

**更新文件**：
```
src/main/resources/daoMapper/
├── AnalysisTaskDaoMapper.xml     # 分析任务Mapper
└── AiReportDaoMapper.xml         # AI报告Mapper
```

**主要变更**：
1. ✅ `AnalysisTaskDaoMapper.xml`
   - 更新 `resultMap`：新增 `time_granularity`，简化日期字段
   - 更新 `Base_Column_List`
   - 更新 `insert` 和 `update` 语句

2. ✅ `AiReportDaoMapper.xml`
   - 更新 `resultMap`：替换 `summary` 和 `sections` 为 `report_content`
   - 更新 `Blob_Column_List`
   - 更新 `insert` 和 `update` 语句

---

### 2.8 代码文件调整清单

#### 2.8.1 新增文件

```
src/main/java/cn/webank/dosconfig/
├── enums/
│   ├── EnumStringParseAble.java          # 枚举解析接口
│   └── DateGranularity.java              # 时间粒度枚举
└── entity/attribution/dto/response/
    ├── ChartDataDTO.java                 # 图表数据DTO
    └── MetricItemDTO.java                # 指标项DTO
```

#### 2.8.2 修改文件

```
src/main/java/cn/webank/dosconfig/
├── enums/
│   └── TaskStatus.java                   # 任务状态枚举（DONE→SUCCESS）
├── entity/attribution/
│   ├── AnalysisTask.java                 # 分析任务实体
│   ├── AiReport.java                     # AI报告实体
│   └── dto/
│       ├── request/
│       │   └── CreateTaskRequest.java    # 创建任务请求
│       └── response/
│           ├── TaskCreateDTO.java        # 任务创建响应
│           ├── MetricTrendDTO.java       # 指标趋势响应
│           └── AiAttributionReportDTO.java # AI报告响应
├── controller/
│   └── AttributionController.java        # Controller
└── service/
    ├── AttributionService.java           # Service接口
    └── impl/
        └── AttributionServiceImpl.java   # Service实现（需补充实现逻辑）

src/main/resources/daoMapper/
├── AnalysisTaskDaoMapper.xml            # 分析任务Mapper
└── AiReportDaoMapper.xml                # AI报告Mapper

dbScript/v1.0.0/
└── init_schema.sql                      # 建表语句
```

#### 2.8.3 删除文件

```
src/main/java/cn/webank/dosconfig/enums/
└── TimeGranularity.java                 # 已删除，改用DateGranularity

src/main/java/cn/webank/dosconfig/entity/attribution/dto/response/
└── ReportSectionDTO.java                # 已删除，不再需要
```

---

## 三、接口文档

已创建完整的接口文档：
```
接口文档-API.md
```

**文档内容包括**：
- ✅ 所有接口的详细说明
- ✅ 请求参数和响应格式
- ✅ 枚举类型说明
- ✅ 数据模型说明
- ✅ 接口调用示例
- ✅ 变更记录

---

## 四、注意事项

### 4.1 需要实现的逻辑

以下方法需要根据业务逻辑进行实现：

1. **AttributionServiceImpl.getMetricTrend()**
   - 根据时间粒度聚合数据
   - 构造 ECharts 格式的图表数据
   - 计算关键指标（均值、变化率等）

2. **AttributionServiceImpl.createTask()**
   - 处理新的日期字段
   - 保存时间粒度信息

3. **AttributionServiceImpl.executeAttributionAnalysisAsync()**
   - 根据时间粒度执行不同的分析逻辑

4. **AttributionServiceImpl.getAiReport()**
   - 返回完整的报告内容
   - AI生成逻辑需要后续实现

### 4.2 数据库迁移

如果现有数据库已有数据，需要执行数据迁移：

```sql
-- 1. 备份现有数据
CREATE TABLE t_analysis_task_backup AS SELECT * FROM t_analysis_task;
CREATE TABLE t_ai_report_backup AS SELECT * FROM t_ai_report;

-- 2. 添加新字段
ALTER TABLE t_analysis_task ADD COLUMN time_granularity VARCHAR(20) NOT NULL DEFAULT 'DAY' COMMENT '时间粒度';
ALTER TABLE t_analysis_task ADD COLUMN baseline_date DATE;
ALTER TABLE t_analysis_task ADD COLUMN compare_date DATE;

-- 3. 数据迁移（将开始日期作为单一日期）
UPDATE t_analysis_task SET baseline_date = baseline_start_date, compare_date = compare_start_date;

-- 4. 删除旧字段
ALTER TABLE t_analysis_task DROP COLUMN baseline_start_date;
ALTER TABLE t_analysis_task DROP COLUMN baseline_end_date;
ALTER TABLE t_analysis_task DROP COLUMN compare_start_date;
ALTER TABLE t_analysis_task DROP COLUMN compare_end_date;

-- 5. AI报告表调整
ALTER TABLE t_ai_report ADD COLUMN report_content LONGTEXT COMMENT '报告内容';
-- 如需迁移旧数据，可将summary和sections合并到report_content
UPDATE t_ai_report SET report_content = CONCAT('# 报告摘要\n\n', IFNULL(summary, ''), '\n\n# 详细内容\n\n', IFNULL(sections, ''));
ALTER TABLE t_ai_report DROP COLUMN summary;
ALTER TABLE t_ai_report DROP COLUMN sections;
```

### 4.3 前端调整

前端需要相应调整：

1. **指标趋势查询**
   - 传参调整：新增 `timeGranularity`，简化日期参数
   - 数据展示：使用 `chartData` 直接渲染 ECharts 图表
   - 指标展示：遍历 `metricItems` 展示关键指标卡片

2. **创建任务表单**
   - 新增时间粒度选择器（日/周/月/年）
   - 简化日期选择：只需选择基准日期和对比日期

3. **任务状态显示**
   - 将 `DONE` 状态改为 `SUCCESS`

4. **AI报告展示**
   - 直接展示 `reportContent` 内容（支持Markdown格式）

---

## 五、测试建议

### 5.1 单元测试

```java
@Test
public void testDateGranularityEnum() {
    assertEquals("yyyy-MM-dd", DateGranularity.DAY.getNormalFmt());
    assertEquals("%Y-%m-%d", DateGranularity.DAY.getSymFmt());
}

@Test
public void testCreateTaskWithNewParams() {
    CreateTaskRequest request = new CreateTaskRequest(
        "loan_balance_increment",
        null,
        new BigDecimal("0.1"),
        DateGranularity.DAY,
        "2024-01-01",
        "2024-01-08"
    );
    // 验证参数校验逻辑
}
```

### 5.2 接口测试

使用 `api-test.http` 文件进行接口测试：

```http
### 1. 查询指标趋势（新参数）
GET http://localhost:8080/attribution/metrics/finance.loan_increase_amount/trend?timeGranularity=DAY&baselineDate=2024-01-01&compareDate=2024-01-08

### 2. 创建任务（新参数）
POST http://localhost:8080/attribution/tasks
Content-Type: application/json
X-User-Name: test

{
  "treeId": "loan_balance_increment",
  "contributionThreshold": 0.1,
  "timeGranularity": "DAY",
  "baselineDate": "2024-01-01",
  "compareDate": "2024-01-08"
}

### 3. 查询任务状态
GET http://localhost:8080/attribution/tasks/{{taskId}}/status

### 4. 查询AI报告
GET http://localhost:8080/attribution/tasks/{{taskId}}/ai-report
```

---

## 六、总结

### 6.1 完成情况

| 任务项 | 状态 | 说明 |
|--------|------|------|
| 1. 任务状态枚举优化 | ✅ | DONE → SUCCESS |
| 2. 核心指标趋势接口调整 | ✅ | 入参简化，返回结构通用化 |
| 3. 发起任务接口优化 | ✅ | 新增时间粒度，简化日期参数 |
| 4. AI报告结构优化 | ✅ | 改为单一大TEXT字段 |
| 5. 数据库表结构更新 | ✅ | t_analysis_task 和 t_ai_report |
| 6. 建表语句更新 | ✅ | init_schema.sql |
| 7. MyBatis Mapper 更新 | ✅ | AnalysisTaskDaoMapper.xml, AiReportDaoMapper.xml |
| 8. Controller 调整 | ✅ | AttributionController.java |
| 9. Service 接口调整 | ✅ | AttributionService.java |
| 10. DTO 类调整 | ✅ | CreateTaskRequest, TaskCreateDTO, MetricTrendDTO 等 |
| 11. 实体类调整 | ✅ | AnalysisTask.java, AiReport.java |
| 12. 接口文档编写 | ✅ | 接口文档-API.md |

### 6.2 优化优势

1. ✅ **接口更简洁**：参数数量减少，调用更方便
2. ✅ **数据更通用**：图表数据采用 ECharts 标准格式，前端直接使用
3. ✅ **结构更清晰**：时间粒度明确，便于数据聚合
4. ✅ **易于扩展**：MetricItemDTO 支持灵活添加新指标
5. ✅ **文档完善**：详细的接口文档，便于对接和维护

---

**完成日期**: 2024年11月24日  
**维护团队**: 开发团队

